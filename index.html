<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taskmaster Team Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            min-height: 100vh;
        }
        .bg-gradient-purple {
            background: linear-gradient(135deg, #9333ea 0%, #ec4899 50%, #ef4444 100%);
            min-height: 100vh;
            padding: 1rem;
        }
        .bg-gradient-blue {
            background: linear-gradient(135deg, #2563eb 0%, #a855f7 50%, #ec4899 100%);
            min-height: 100vh;
            padding: 1rem;
        }
        .container {
            max-width: 72rem;
            margin: 0 auto;
        }
        .container-small {
            max-width: 56rem;
            margin: 0 auto;
        }
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .team-card {
            background: linear-gradient(135deg, #eff6ff 0%, #f3e8ff 100%);
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 2px solid #d8b4fe;
        }
        .header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        .title {
            font-size: 2.25rem;
            font-weight: bold;
            color: #1f2937;
        }
        .subtitle {
            color: #6b7280;
            font-size: 1.125rem;
            margin-bottom: 2rem;
        }
        .grid {
            display: grid;
            gap: 1.5rem;
        }
        @media (min-width: 768px) {
            .grid-2 {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .team-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        .team-name {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .team-name h2 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
        }
        .team-stats {
            text-align: right;
        }
        .team-score {
            font-size: 1.875rem;
            font-weight: bold;
            color: #9333ea;
        }
        .team-percentage {
            font-size: 0.875rem;
            color: #6b7280;
        }
        .url-box {
            background: white;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .url-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }
        .url-text {
            background: #f9fafb;
            padding: 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #e5e7eb;
            word-break: break-all;
            font-size: 0.875rem;
            color: #374151;
            font-family: monospace;
        }
        .btn {
            width: 100%;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        .btn-blue {
            background: #3b82f6;
            color: white;
            margin-top: 0.5rem;
        }
        .btn-blue:hover {
            background: #2563eb;
        }
        .btn-purple {
            background: #9333ea;
            color: white;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-purple:hover {
            background: #7e22ce;
        }
        .btn-red {
            background: #ef4444;
            color: white;
            padding: 0.75rem 1rem;
            margin-top: 1rem;
        }
        .btn-red:hover {
            background: #dc2626;
        }
        .qr-box {
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .qr-box img {
            width: 100%;
            height: auto;
        }
        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: #f9fafb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }
        .rank {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .rank-1 { color: #eab308; }
        .rank-2 { color: #9ca3af; }
        .rank-3 { color: #d97706; }
        .rank-other { color: #9ca3af; }
        .leaderboard-info {
            flex: 1;
        }
        .leaderboard-name {
            font-weight: 600;
            color: #1f2937;
        }
        .progress-bar {
            width: 100%;
            background: #e5e7eb;
            border-radius: 9999px;
            height: 0.5rem;
            margin-top: 0.25rem;
            overflow: hidden;
        }
        .progress-fill {
            background: #9333ea;
            height: 100%;
            border-radius: 9999px;
            transition: width 0.3s;
        }
        .leaderboard-score {
            font-size: 1.5rem;
            font-weight: bold;
            color: #9333ea;
        }
        .progress-box {
            background: linear-gradient(90deg, #f3e8ff 0%, #fce7f3 100%);
            border-radius: 0.5rem;
            padding: 1rem;
        }
        .progress-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        .progress-label {
            font-size: 1.125rem;
            font-weight: 600;
            color: #374151;
        }
        .progress-score {
            font-size: 1.5rem;
            font-weight: bold;
            color: #9333ea;
        }
        .progress-bar-large {
            width: 100%;
            background: white;
            border-radius: 9999px;
            height: 1rem;
            overflow: hidden;
        }
        .progress-fill-large {
            background: linear-gradient(90deg, #9333ea 0%, #ec4899 100%);
            height: 100%;
            border-radius: 9999px;
            transition: width: 0.5s;
        }
        .progress-percentage {
            text-align: right;
            margin-top: 0.25rem;
            font-size: 0.875rem;
            color: #6b7280;
        }
        .tasks-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 1rem;
        }
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .task-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid #e5e7eb;
            background: #f9fafb;
        }
        .task-item:hover {
            border-color: #d8b4fe;
        }
        .task-item.completed {
            background: #f0fdf4;
            border-color: #86efac;
        }
        .task-icon {
            width: 1.5rem;
            height: 1.5rem;
            flex-shrink: 0;
        }
        .task-content {
            flex: 1;
        }
        .task-number {
            font-size: 0.875rem;
            font-weight: 600;
            color: #6b7280;
        }
        .task-number.completed {
            color: #15803d;
        }
        .task-text {
            color: #1f2937;
        }
        .task-text.completed {
            color: #15803d;
            text-decoration: line-through;
        }
        .icon-yellow { color: #eab308; }
        .icon-purple { color: #9333ea; }
        .icon-green { color: #16a34a; }
        .icon-gray { color: #9ca3af; }
        svg {
            width: 100%;
            height: 100%;
        }
        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }
        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem;
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading">Loading...</div>
    </div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, onValue, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD8QQ1IzI31E0WXjf4azJ0JlTnkHLba6_E",
            authDomain: "taskmaster-d8b0d.firebaseapp.com",
            databaseURL: "https://taskmaster-d8b0d-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "taskmaster-d8b0d",
            storageBucket: "taskmaster-d8b0d.firebasestorage.app",
            messagingSenderId: "384464868716",
            appId: "1:384464868716:web:4e8f2ef25b088ba7c1cf49"
        };

        let app, database;
        
        try {
            // Initialize Firebase
            app = initializeApp(firebaseConfig);
            database = getDatabase(app);
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            document.getElementById('root').innerHTML = `
                <div class="error">
                    <h2>Connection Error</h2>
                    <p>Could not connect to Firebase: ${error.message}</p>
                    <p>Please check your Firebase configuration and database rules.</p>
                </div>
            `;
        }

        const teams = [
            { name: 'Manuka', code: 'xk7mp9qw', colors: { from: '#78350f', via: '#92400e', to: '#a16207' } },
            { name: 'Rimu', code: 'r5nt8jvz', colors: { from: '#ea580c', via: '#f97316', to: '#fb923c' } },
            { name: 'Kawakawa', code: 'f2hy6lbg', colors: { from: '#15803d', via: '#16a34a', to: '#22c55e' } },
            { name: 'Kowhai', code: 'w3ds9kcm', colors: { from: '#ca8a04', via: '#eab308', to: '#fde047' } }
        ];

        const defaultTasks = [
            "Take a team photo with a stranger",
            "Find something that weighs exactly 100 grams",
            "Make a tower using only office supplies",
            "Create a 30-second jingle about your company",
            "Get a business card from 3 different companies",
            "Find the oldest coin possible",
            "Take a photo with something yellow",
            "Build the longest paper chain in 5 minutes",
            "Get 5 people to sign a piece of paper",
            "Find something that starts with each letter of your team name",
            "Create an origami animal",
            "Take a photo spelling your team name with objects",
            "Find the most unusual item in a 2-minute radius",
            "Get a stranger to draw your team logo",
            "Make a hat out of newspaper",
            "Take a selfie with a landmark",
            "Find 10 different leaves",
            "Create a human pyramid",
            "Get someone to tell you a joke and record it",
            "Find something older than the youngest team member",
            "Make a boat that floats using only paper",
            "Take a photo of your team in alphabetical order by first name",
            "Find an item from each color of the rainbow",
            "Create a team handshake",
            "Get 3 email addresses from strangers",
            "Find the longest receipt possible",
            "Take a photo of your team doing a yoga pose",
            "Create a sculpture using only natural materials",
            "Get a stranger to say your team motto",
            "Find something that makes noise",
            "Take a photo with all team members off the ground",
            "Create a word with 5+ letters using only items you find",
            "Get someone to compliment each team member",
            "Find the most business cards in 10 minutes",
            "Take a photo of your team recreating a famous movie scene",
            "Create a team flag using found materials",
            "Get 5 different people to say hello in different languages",
            "Find something that smells nice",
            "Take a synchronized jumping photo",
            "Make up and perform a team cheer"
        ];

        let currentView = 'admin';
        let selectedTeam = null;
        let tasks = defaultTasks;
        let teamData = {};

        // Listen for real-time updates
        if (database) {
            const dataRef = ref(database, 'taskmaster');
            onValue(dataRef, (snapshot) => {
                console.log('Data received from Firebase:', snapshot.val());
                const data = snapshot.val();
                if (data) {
                    tasks = data.tasks || defaultTasks;
                    teamData = data.teamData || {};
                } else {
                    // Initialize database if empty
                    console.log('Initializing database...');
                    initializeData();
                }
                render();
            }, (error) => {
                console.error('Firebase read error:', error);
                document.getElementById('root').innerHTML = `
                    <div class="error">
                        <h2>Database Error</h2>
                        <p>${error.message}</p>
                        <p>Please check your Firebase database rules. They should be set to allow read and write access.</p>
                    </div>
                `;
            });
        }

        function initializeData() {
            const initialData = {};
            teams.forEach(team => {
                initialData[team.name] = Array(40).fill(false);
            });
            
            const dataRef = ref(database, 'taskmaster');
            set(dataRef, {
                tasks: defaultTasks,
                teamData: initialData
            }).then(() => {
                console.log('Database initialized successfully');
            }).catch((error) => {
                console.error('Error initializing database:', error);
            });
        }

        function toggleTask(teamName, taskIndex) {
            const dataRef = ref(database, 'taskmaster');
            const updates = {};
            updates[`teamData/${teamName}/${taskIndex}`] = !teamData[teamName][taskIndex];
            update(dataRef, updates).then(() => {
                console.log('Task updated successfully');
            }).catch((error) => {
                console.error('Error updating task:', error);
                alert('Error updating task. Please try again.');
            });
        }

        function resetAllData() {
            if (confirm('Are you sure you want to reset ALL team progress? This cannot be undone!')) {
                initializeData();
            }
        }

        function generateTeamURL(teamCode) {
            const baseUrl = window.location.href.split('?')[0].split('#')[0];
            return `${baseUrl}?team=${teamCode}`;
        }

        function generateQRCode(teamCode) {
            const url = generateTeamURL(teamCode);
            return `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(url)}`;
        }

        function getCompletionStats(teamName) {
            if (!teamData[teamName]) return { completed: 0, total: 40, percentage: 0 };
            const completed = teamData[teamName].filter(t => t).length;
            return {
                completed,
                total: 40,
                percentage: Math.round((completed / 40) * 100)
            };
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('URL copied to clipboard!');
            });
        }

        function renderAdmin() {
            const sortedTeams = teams.map(team => ({
                ...team,
                ...getCompletionStats(team.name)
            })).sort((a, b) => b.completed - a.completed);

            return `
                <div class="bg-gradient-purple">
                    <div class="container">
                        <div class="card">
                            <div class="header">
                                <div class="task-icon icon-yellow">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/>
                                        <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/>
                                        <path d="M4 22h16"/>
                                        <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/>
                                        <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/>
                                        <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/>
                                    </svg>
                                </div>
                                <h1 class="title">Taskmaster Control Center</h1>
                            </div>
                            <p class="subtitle">Share the unique URLs below with each team. Each team can only access their own page.</p>
                            
                            <div class="grid grid-2">
                                ${teams.map(team => {
                                    const stats = getCompletionStats(team.name);
                                    const teamUrl = generateTeamURL(team.code);
                                    return `
                                        <div class="team-card">
                                            <div class="team-header">
                                                <div class="team-name">
                                                    <div class="task-icon icon-purple">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                                            <circle cx="9" cy="7" r="4"/>
                                                            <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                                                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                                        </svg>
                                                    </div>
                                                    <h2>${team.name}</h2>
                                                </div>
                                                <div class="team-stats">
                                                    <div class="team-score">${stats.completed}/40</div>
                                                    <div class="team-percentage">${stats.percentage}% complete</div>
                                                </div>
                                            </div>
                                            
                                            <div class="url-box">
                                                <div class="url-label">Team URL:</div>
                                                <div class="url-text">${teamUrl}</div>
                                                <button class="btn btn-blue" onclick="window.copyToClipboard('${teamUrl}')">
                                                    Copy URL
                                                </button>
                                            </div>
                                            
                                            <div class="qr-box">
                                                <img src="${generateQRCode(team.code)}" alt="QR Code for ${team.name}">
                                            </div>
                                            
                                            <button class="btn btn-purple" onclick="window.viewTeam('${team.name}')">
                                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <line x1="8" y1="6" x2="21" y2="6"/>
                                                    <line x1="8" y1="12" x2="21" y2="12"/>
                                                    <line x1="8" y1="18" x2="21" y2="18"/>
                                                    <line x1="3" y1="6" x2="3.01" y2="6"/>
                                                    <line x1="3" y1="12" x2="3.01" y2="12"/>
                                                    <line x1="3" y1="18" x2="3.01" y2="18"/>
                                                </svg>
                                                View Team Tasks
                                            </button>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            
                            <button class="btn btn-red" onclick="window.resetAllData()">
                                Reset All Progress
                            </button>
                        </div>

                        <div class="card">
                            <h2 style="font-size: 1.5rem; font-weight: bold; color: #1f2937; margin-bottom: 1rem;">Leaderboard</h2>
                            <div>
                                ${sortedTeams.map((item, index) => `
                                    <div class="leaderboard-item">
                                        <div class="rank rank-${index === 0 ? '1' : index === 1 ? '2' : index === 2 ? '3' : 'other'}">
                                            #${index + 1}
                                        </div>
                                        <div class="leaderboard-info">
                                            <div class="leaderboard-name">${item.name}</div>
                                            <div class="progress-bar">
                                                <div class="progress-fill" style="width: ${item.percentage}%"></div>
                                            </div>
                                        </div>
                                        <div class="leaderboard-score">${item.completed}/40</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTeam() {
            const stats = getCompletionStats(selectedTeam);
            const team = teams.find(t => t.name === selectedTeam);
            const gradient = `linear-gradient(135deg, ${team.colors.from} 0%, ${team.colors.via} 50%, ${team.colors.to} 100%)`;
            const progressGradient = `linear-gradient(90deg, ${team.colors.from} 0%, ${team.colors.to} 100%)`;
            
            return `
                <div class="bg-gradient-blue" style="background: ${gradient};">
                    <div class="container-small">
                        <div class="card">
                            <div>
                                <h1 style="font-size: 1.875rem; font-weight: bold; color: #1f2937;">${selectedTeam}</h1>
                                <p style="color: #6b7280; margin-top: 0.25rem;">Complete all 40 tasks to win!</p>
                            </div>
                            
                            <div class="progress-box" style="margin-top: 1rem;">
                                <div class="progress-header">
                                    <span class="progress-label">Progress</span>
                                    <span class="progress-score" style="color: ${team.colors.via};">${stats.completed}/40</span>
                                </div>
                                <div class="progress-bar-large">
                                    <div class="progress-fill-large" style="width: ${stats.percentage}%; background: ${progressGradient};"></div>
                                </div>
                                <div class="progress-percentage">${stats.percentage}% complete</div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="tasks-header">
                                <div class="task-icon" style="color: ${team.colors.via};">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/>
                                        <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/>
                                        <path d="M4 22h16"/>
                                        <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/>
                                        <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/>
                                        <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/>
                                    </svg>
                                </div>
                                Tasks
                            </div>
                            <div class="task-list">
                                ${tasks.map((task, index) => {
                                    const isCompleted = teamData[selectedTeam]?.[index] || false;
                                    return `
                                        <div class="task-item ${isCompleted ? 'completed' : ''}" onclick="window.toggleTask('${selectedTeam}', ${index})" style="${!isCompleted ? `border-color: ${team.colors.to}33;` : ''}">
                                            <div class="task-icon ${isCompleted ? 'icon-green' : ''}" style="${!isCompleted ? `color: ${team.colors.via};` : ''}">
                                                ${isCompleted ? `
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/>
                                                        <path d="m9 12 2 2 4-4"/>
                                                    </svg>
                                                ` : `
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <circle cx="12" cy="12" r="10"/>
                                                    </svg>
                                                `}
                                            </div>
                                            <div class="task-content">
                                                <span class="task-number ${isCompleted ? 'completed' : ''}" style="${!isCompleted ? `color: ${team.colors.via};` : ''}">Task ${index + 1}</span>
                                                <p class="task-text ${isCompleted ? 'completed' : ''}">${task}</p>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function viewTeam(teamName) {
            selectedTeam = teamName;
            currentView = 'team';
            render();
        }

        function render() {
            const root = document.getElementById('root');
            if (currentView === 'admin') {
                root.innerHTML = renderAdmin();
            } else {
                root.innerHTML = renderTeam();
            }
        }

        // Check URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const teamCode = urlParams.get('team');

        if (teamCode) {
            const team = teams.find(t => t.code === teamCode);
            if (team) {
                selectedTeam = team.name;
                currentView = 'team';
            }
        }

        // Expose functions globally
        window.toggleTask = toggleTask;
        window.viewTeam = viewTeam;
        window.copyToClipboard = copyToClipboard;
        window.resetAllData = resetAllData;
    </script>
</body>
</html>
